using LinearAlgebra
using DynamicPolynomials
using SwitchOnSafety
using Combinatorics
using SparseArrays
using JuMP, MosekTools
using SpecialFunctions
using ControlSystems
using Plots
using LaTeXStrings



include("../src/RandomTrajectories.jl")
include("../src/AlgebraicLift.jl")
include("../src/JSRCompute.jl")
include("../src/ProbabilisticCertificates.jl")
include("../src/WhiteBoxAnalysis.jl")




dim = 6; numMode = 3; dimOut = 2; horizon = 10;

numScen_budget = 20000

#A = [[-0.1 -0.50 -0.4; 1 0.2 0.1; 0 -0.9 0.8], [-0.1 0.9 -0.4; 0.5 0.9 -0.8; -0.8 0.5 0.5], [0.5 0.1 0.4; 0.8 0.8 0.2; -0.2 -0.9 -0.5]]
#C = [rand(dimOut,dim) for i in 1:numMode]

#A = [4*rand(dim,dim).-2 for i in 1:numMode]
#C = [2*rand(dimOut,dim).-1 for i in 1:numMode]

A = [[0.2754 0.3903 -0.3111 0.8320 -0.3551 -0.0530;0.9154 -0.8640 0.5610 -0.9977 0.5695 -0.6946;-0.5186 -0.4904 0.3507 -0.0751 -0.0573 -0.3178;0.3522 -0.5519 -0.9866 -0.1513 -0.9285 0.2148;-0.4219  0.3357 0.2043 -0.0782 -0.6483 -0.6165;0.3436 0.6888 -0.2265 0.5403 0.4435 0.4769],[-0.5143 -0.8178  0.2952 -0.5275 0.5406 -0.4871;0.8348 0.1524 0.3580 -0.7612 -0.2996 0.2269;-0.4619 0.3667 0.2716 0.2146 0.3240 0.1645;0.5310 0.0932 0.8903 -0.0997 -0.1677 0.0815;-0.6227 -0.1485 -0.5821 -0.0825 0.6839 0.7399;-0.4250 0.2889 0.4186 0.3239 0.6658 -0.4704],[-0.3639 0.0894 -0.5626 -0.2684 -0.6159  0.7223;-0.7616 0.2946 -0.7884 0.5270 -0.7223 -0.0303;0.8797 0.0878 -0.7806 0.2558 0.3925 -0.2131;0.2911 0.4421 -0.8728 0.5440 -0.8124 0.3429;-0.0411 0.0450 -0.1908 0.8657 0.0508  0.4825;0.2786 0.9874 -0.1033 0.9455 0.0607  0.0401]]
C = [[-0.5775 -0.0371 0.3612 -0.0932 -0.3099 0.2221; 0.4844 -0.5213 -0.1990 -0.7322 -0.6327 -0.1087], [0.8657 0.4858 -0.3746 0.9694 -0.9391 -0.3568; -0.9466 0.9470 0.6555 0.3157 0.6156 0.0110], [-0.0863 -0.2196 -0.0408 0.1961 0.9592 -0.7535; 0.3726 -0.2672 -0.9006 -0.3858 -0.3749 -0.4980]]
#jsr = 1.6408

#A = [[1.057097524556652 1.7949010399656808 0.46440670618884905 1.600120162205564 0.09881410215255926 -0.5586595986898759; -1.2813771597260573 -1.152489017917583 -0.9029351093839253 -1.1132348591933843 -1.770540129566606 -1.0579335796744944; 1.409421285148297 1.3415231157831302 -1.5745323641940674 -1.7262536787615925 1.0982960223720655 0.6631718404792561; -0.7401305011046198 1.0379795221974133 -1.8440710279634924 0.111817941249031 -1.7322529033985674 -1.2741781995664043; 0.7601845258360491 0.6950138384846234 -1.7265154534407978 -1.99283021362709 -0.1722421303597974 -1.2894936937635393; 1.0380904710068473 -1.424327475347754 -0.4791380274646615 -0.2660627909690687 0.9537199855108964 1.0588308399113266], [-1.913957240072203 -0.31670625149379283 1.716026548283474 -1.0034309598523734 -0.37123656409743777 1.4267699559723397; -1.3929351391885163 -1.857012561838137 1.786354802766322 0.31189993005892624 0.3549358934125664 1.5627110137247664; 1.1903638711776559 1.2317533175798845 0.7726227634242653 0.8126265618245885 -1.1272450065732356 0.1094226523670363; 0.18979329953808932 0.8057901300368826 -0.662760739880671 0.9590204000231006 1.2742441038541 -1.569589305265719; 0.38126701106530714 -0.33218399681642996 -0.7678375027215711 0.9788985377607187 0.02707788465518224 -0.16658714925579954; -1.6201588527018016 1.462122507542409 -1.3829215374045205 -1.6169834344320266 -0.9046108485132809 0.5814675050445892], [-0.06917516003303081 -1.4967138624083294 0.5677508214799118 0.3814822552007344 1.773669496227912 -1.1091789945999153; 1.8751768310548176 -1.2767836641430979 1.7045203429644582 -0.8416428846471842 1.0939127786360707 0.31776599193832755; -0.4088040685900802 -1.7512741185613745 1.463386231320234 -0.7698082353413778 -1.2938829322257872 0.36860978602563765; 0.5806763669167685 -0.7192683034501837 1.849753898311496 1.3086149178652375 -1.7575016052185974 -1.3060020434763633; -0.32419350976628447 -1.7352278215704215 -0.6595903842179638 0.11849261857882798 0.6040703912189143 1.1655228240678035; 1.0770413019331748 1.2621746013449444 -1.7158956913130003 0.38396941964685816 0.9120890663221166 0.402463686537498]]
#C = [[0.401875423944289 0.7482145762472139 0.6535759009424678 -0.6311857937234588 -0.02838707874084534 -0.34828388603488714; -0.6423262803597409 -0.36163847794178006 0.6923842996119687 0.49128841914715293 -0.3017313953100311 0.02126266230342999], [0.05436373872676903 0.6984806605568044 -0.34516494219983374 -0.8250805460198083 -0.5808252126102316 -0.4559163057309208; 0.5181755831367059 0.04343589455464514 -0.741562986948348 -0.37946886096681176 0.5869802344084198 -0.0423918617262391], [-0.37857725437226897 0.482752998880851 -0.6882636078794491 0.7513142158397308 -0.19301980789560158 0.5273242436225156; -0.743436959044077 0.033040111722018484 -0.6352596115726801 0.334899775138199 -0.8318035882228219 0.25413013551962216]]


#=
obsvtest = false
for i in 1:numMode
    global obsvtest
    if rank(obsv(A[i],C[i])) == dim
        obsvtest = true
    end
end

println(obsvtest)
if obsvtest
    #jsrwhite= white_box_jsr(A)
    #println("JSR true: $jsrwhite")

    traj_budget = generate_trajectories(horizon,A,C,numScen_budget)
    xik = obsindexestimate(traj_budget,dimOut)
    println(xik)
    logxik = log.(xik)
    println(logxik)

end

gr(size = (600, 400))
fn = plot(1:1:Int64(1e1), xi,xlabel=L"k",ylabel=L"\log(\xi_k(\omega_N))",lw = 2,xtickfontsize=12,ytickfontsize=12,legend=false)
savefig(fn,"logxik.png")
=#







gammalist = []
k = 3
shift = horizon-k
Xscale = veroneseliftscale(dimOut*k,1)
traj_budget = generate_trajectories(horizon,A,C,numScen_budget)
state0_budget = traj_budget[1:dimOut*k,:]
state_budget = traj_budget[end-dimOut*k+1:end,:]

for N in 1000:1000:numScen_budget

    P0 = Matrix(I,dimOut*k,dimOut*k)
    ga0 = convergerate(state0_budget[:,1:N],state_budget[:,1:N],1,P0,Xscale)
    ga0 = ga0^(1/shift)
    P,ga = data_driven_lyapb_sos(state0_budget[:,1:N],state_budget[:,1:N],shift,1,ga0,Xscale)
    push!(gammalist,ga)

    println(repeat('*', 80))
    #println("JSR true: $jsrwhite")
    println("gamma list: $gammalist")
    println(repeat('*', 80))
end

#=
horizon = 10
Any[1.5589396279200805, 1.577308363388637, 1.5938422077374044, 1.6210617277243136, 1.624330213392033, 1.6277594442565255, 1.6282416798468446, 1.6373505743306531, 1.6382078820467763, 1.6413692042499801, 1.6417442763757841, 1.663032706500961, 1.6655594439992778, 1.666328451063983, 1.6692946211707032, 1.6692946211707032, 1.6696241956270053, 1.6696241956270053, 1.6696241956270053, 1.6696241956270053]

horizon = 8
Any[1.6400788492127205, 1.6815761360711585, 1.6927120236801334, 1.7124139786806274, 1.7124139786806274, 1.7225691580722082, 1.7226900698160101, 1.7271638043366762, 1.741733669464792, 1.7466910509606655, 1.7473560655515754, 1.751406608968935, 1.751406608968935, 1.7552757847705922, 1.7552757847705922, 1.7553966965143941, 1.7577544755185293, 1.757935843134232, 1.7651905477623395, 1.7659764740970512]

horizon = 6
Any[1.7955795697892327, 1.8748265790324443, 1.904760521855426, 1.9367727421273022, 1.9387216621116283, 1.9476111454065752, 1.9537937624493948, 1.9565865506605449, 1.9648286817227207, 1.9674171195769574, 2.0325697377894816, 2.0325697377894816, 2.0353606930443693, 2.037246473621997, 2.0625159333621985, 2.063345676816355, 2.0854470251861423, 2.09653541498259, 2.09653541498259, 2.09653541498259]

gammaT10 = [1.5589396279200805, 1.577308363388637, 1.5938422077374044, 1.6210617277243136, 1.624330213392033, 1.6277594442565255, 1.6282416798468446, 1.6373505743306531, 1.6382078820467763, 1.6413692042499801, 1.6417442763757841, 1.663032706500961, 1.6655594439992778, 1.666328451063983, 1.6692946211707032, 1.6692946211707032, 1.6696241956270053, 1.6696241956270053, 1.6696241956270053, 1.6696241956270053]
gammaT8 = [1.6400788492127205, 1.6815761360711585, 1.6927120236801334, 1.7124139786806274, 1.7124139786806274, 1.7225691580722082, 1.7226900698160101, 1.7271638043366762, 1.741733669464792, 1.7466910509606655, 1.7473560655515754, 1.751406608968935, 1.751406608968935, 1.7552757847705922, 1.7552757847705922, 1.7553966965143941, 1.7577544755185293, 1.757935843134232, 1.7651905477623395, 1.7659764740970512]
gammaT6 = [1.7955795697892327, 1.8748265790324443, 1.904760521855426, 1.9367727421273022, 1.9387216621116283, 1.9476111454065752, 1.9537937624493948, 1.9565865506605449, 1.9648286817227207, 1.9674171195769574, 2.0325697377894816, 2.0325697377894816, 2.0353606930443693, 2.037246473621997, 2.0625159333621985, 2.063345676816355, 2.0854470251861423, 2.09653541498259, 2.09653541498259, 2.09653541498259]
JSRtrue = 1.6408


=#






#=
#A = [[0.33171530637435165 0.24755470028020454 -1.1013225492874126 0.42164974426079826 -0.8563040145169554 -0.36713329283395435; -0.9574086606854877 1.573099630442404 1.0210883718785526 0.5378286561296299 -0.2917768288322211 -1.0937933405312927; -1.110874390829001 0.3237899878249699 -0.49388112184525657 0.22990549207982536 1.9417520187012514 -1.308755622951467; 0.8268503417844917 -0.2183119290116462 0.6153654212337125 1.1612227781873266 1.2124276960007068 -1.533038945612394; -1.6223953980886874 -0.30581934776887376 -0.328294721385733 0.16875918492340158 0.8581498213196754 0.7513875560641372; -1.6641594469086618 -0.7687988000976294 1.6486186515795076 -0.17305389254272008 -0.38873415527804234 -0.14071343004230652], [-1.3265984047270276 0.25221500571520394 1.1910532378092293 -0.17264685023390047 0.746685671645289 0.9039353886712895; 1.0771718068882379 -0.9050881117434191 -0.20816019387390838 -1.5880490075672622 -0.06184312421968574 -0.10541268279057725; 0.6868210469610858 -0.17205708132667308 1.367595248589895 -0.07592260725407751 -1.3029184652423638 0.5998194632393119; 1.2897739963917703 -0.8015982436013349 0.041431623698807485 0.31768033569641396 1.7741790283937657 1.1085871421248195; -0.38584366064798914 -0.06152600315003287 1.36012690432897 -1.7910454150872193 1.342367304348909 -0.41482971471024577; -1.1233208210040688 0.7303490223624287 1.3363150828599553 0.6882169586455102 1.1657164568214613 -0.8664015676686914], [1.175267039285929 -0.30682181718291357 0.14515698002722832 0.31825521594731665 -0.40788821345022797 -0.68297988724684; -0.7242105592544421 1.7457564324897925 1.4408399448461093 -1.7523856956201076 -0.5769991550911744 -0.6376910483129006; 1.5453631398738894 -0.703000358761404 0.5242509314086856 1.6845418109667696 1.9466001268176463 -1.7059230785224635; -1.2358839195948184 1.3770180605448683 0.316694040630626 0.5164322017449141 -0.1566233817870053 1.6814379087986744; 1.2222077588202493 -1.004536193931437 -0.1900160343036843 1.4045384096383318 -0.22978993406983328 -1.4500470300625858; -0.21084191240944783 0.17318131553892346 0.7904466609949239 -0.980619159660054 0.5840731953868818 1.573767269262813]]
#C = [[-0.7026273723700056 -0.5509642000867689 -0.0011085510497546025 0.6910160253168023 0.7662367288302154 -0.5436944628366187; 0.14321669977656049 0.5243536800936051 0.6747151871640336 0.21518422235089885 -0.3401391338235067 0.08000874025660609; -0.13749126306669046 0.5774386327302481 -0.13782200002583433 0.9631367368604362 -0.7316762928712253 -0.703337035494354], [0.6784653141535966 -0.9309976392064634 0.8671251331376904 0.06264114219371963 -0.6660889916581874 -0.20730588712998754; 0.6322043309739858 -0.4108922725480446 0.25680168592111174 -0.9100964981330621 0.888728362603441 0.5420977984640767; 0.5753037875549603 0.47741091252747614 -0.6213308442251075 0.4402179420431809 0.8043039191127686 -0.7951142605870456], [-0.47835816739635284 0.6336181789709547 -0.9398273442128113 -0.0907376113826821 -0.2983042487547376 -0.817104214029531; -0.4733082091105385 0.6691514747720655 -0.7685741341944388 0.39764714842382887 -0.780299169372741 -0.0034902730279466887; -0.7708551991299015 -0.3231649215744361 -0.6055232904900141 -0.1898220906705812 0.016976214131142697 -0.2785438986147999]]
horizon = 10
JSR true: 2.9212307127312944
gamma list: Any[2.661683271549067, 2.7557365742142026, 2.7779657012946917, 2.7990002724806686, 2.8114132663410354, 2.8214371484123775, 2.836958482650755, 2.8511597949579177, 2.8593907596420687, 2.8596805823422144, 2.8621730575634716, 2.8685491569666874, 2.878403128771657, 2.878403128771657, 2.887735419716363, 2.889300462297153, 2.8895323204572696, 2.8895323204572696, 2.8905756821777957, 2.8915031148182635]

horizon = 8
gamma list: Any[2.7627663318452855, 2.8281605924645614, 2.8640201395226272, 2.8919736447096236, 2.911456390749046, 2.9164823745099397, 2.9378286875618285, 2.9782624445595838, 3.2393312414878332, 2.9844743346011384]
gamma list: Any[2.782307669564318, 2.802163083354567, 2.833193948622389, 2.8369914321341865, 2.904369639586344, 2.9109338610853066, 2.934970946767213, 2.943917130033138, 2.9585820760196855, 2.9602807184119504]
gamma list: Any[2.7771666443196965, 2.820040298359232, 2.861406113771846, 2.865772194424327, 2.8856434589324165, 2.8971494953319, 2.9167966238059675, 2.931584375152209, 2.9466147103971116, 2.9466147103971116, 2.947990235835291, 2.9488275121889664]

gamma list: Any[2.7437758739492653, 2.8214978364175725, 2.8319278272937685, 2.8705770320634305, 2.8882603668484546, 2.9042480873755365, 2.914498582663542, 2.9262218502630413, 2.9322307612939404, 2.9362956128736664, 2.9411852169478294, 2.943306009076382, 2.956914425234596, 2.963806999652392, 2.969815910683291, 2.9774743267030646, 2.9803609604335946, 3.0032183867079962, 3.0034540302778354, 3.0034540302778354]

horizon = 6
gamma list: Any[2.9257206555750237, 3.0224238726605357, 3.1122295706957264, 3.1691539845371297, 3.2018725025957515, 3.2431077715590027, 3.2488928359408584, 3.2570996337296645, 3.260881897058419, 3.279864577161223, 3.284146384703209, 3.293352270918479, 3.297498018909857, 3.308170499653675, 3.308170499653675, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935]


A = [[0.33171530637435165 0.24755470028020454 -1.1013225492874126 0.42164974426079826 -0.8563040145169554 -0.36713329283395435; -0.9574086606854877 1.573099630442404 1.0210883718785526 0.5378286561296299 -0.2917768288322211 -1.0937933405312927; -1.110874390829001 0.3237899878249699 -0.49388112184525657 0.22990549207982536 1.9417520187012514 -1.308755622951467; 0.8268503417844917 -0.2183119290116462 0.6153654212337125 1.1612227781873266 1.2124276960007068 -1.533038945612394; -1.6223953980886874 -0.30581934776887376 -0.328294721385733 0.16875918492340158 0.8581498213196754 0.7513875560641372; -1.6641594469086618 -0.7687988000976294 1.6486186515795076 -0.17305389254272008 -0.38873415527804234 -0.14071343004230652], [-1.3265984047270276 0.25221500571520394 1.1910532378092293 -0.17264685023390047 0.746685671645289 0.9039353886712895; 1.0771718068882379 -0.9050881117434191 -0.20816019387390838 -1.5880490075672622 -0.06184312421968574 -0.10541268279057725; 0.6868210469610858 -0.17205708132667308 1.367595248589895 -0.07592260725407751 -1.3029184652423638 0.5998194632393119; 1.2897739963917703 -0.8015982436013349 0.041431623698807485 0.31768033569641396 1.7741790283937657 1.1085871421248195; -0.38584366064798914 -0.06152600315003287 1.36012690432897 -1.7910454150872193 1.342367304348909 -0.41482971471024577; -1.1233208210040688 0.7303490223624287 1.3363150828599553 0.6882169586455102 1.1657164568214613 -0.8664015676686914], [1.175267039285929 -0.30682181718291357 0.14515698002722832 0.31825521594731665 -0.40788821345022797 -0.68297988724684; -0.7242105592544421 1.7457564324897925 1.4408399448461093 -1.7523856956201076 -0.5769991550911744 -0.6376910483129006; 1.5453631398738894 -0.703000358761404 0.5242509314086856 1.6845418109667696 1.9466001268176463 -1.7059230785224635; -1.2358839195948184 1.3770180605448683 0.316694040630626 0.5164322017449141 -0.1566233817870053 1.6814379087986744; 1.2222077588202493 -1.004536193931437 -0.1900160343036843 1.4045384096383318 -0.22978993406983328 -1.4500470300625858; -0.21084191240944783 0.17318131553892346 0.7904466609949239 -0.980619159660054 0.5840731953868818 1.573767269262813]]
C = [[-0.7026273723700056 -0.5509642000867689 -0.0011085510497546025 0.6910160253168023 0.7662367288302154 -0.5436944628366187; 0.14321669977656049 0.5243536800936051 0.6747151871640336 0.21518422235089885 -0.3401391338235067 0.08000874025660609; -0.13749126306669046 0.5774386327302481 -0.13782200002583433 0.9631367368604362 -0.7316762928712253 -0.703337035494354], [0.6784653141535966 -0.9309976392064634 0.8671251331376904 0.06264114219371963 -0.6660889916581874 -0.20730588712998754; 0.6322043309739858 -0.4108922725480446 0.25680168592111174 -0.9100964981330621 0.888728362603441 0.5420977984640767; 0.5753037875549603 0.47741091252747614 -0.6213308442251075 0.4402179420431809 0.8043039191127686 -0.7951142605870456], [-0.47835816739635284 0.6336181789709547 -0.9398273442128113 -0.0907376113826821 -0.2983042487547376 -0.817104214029531; -0.4733082091105385 0.6691514747720655 -0.7685741341944388 0.39764714842382887 -0.780299169372741 -0.0034902730279466887; -0.7708551991299015 -0.3231649215744361 -0.6055232904900141 -0.1898220906705812 0.016976214131142697 -0.2785438986147999]]
=#



#=
gammaT10 = [2.661683271549067, 2.7557365742142026, 2.7779657012946917, 2.7990002724806686, 2.8114132663410354, 2.8214371484123775, 2.836958482650755, 2.8511597949579177, 2.8593907596420687, 2.8596805823422144, 2.8621730575634716, 2.8685491569666874, 2.878403128771657, 2.878403128771657, 2.887735419716363, 2.889300462297153, 2.8895323204572696, 2.8895323204572696, 2.8905756821777957, 2.8915031148182635]
gammaT8 = [2.7437758739492653, 2.8214978364175725, 2.8319278272937685, 2.8705770320634305, 2.8882603668484546, 2.9042480873755365, 2.914498582663542, 2.9262218502630413, 2.9322307612939404, 2.9362956128736664, 2.9411852169478294, 2.943306009076382, 2.956914425234596, 2.963806999652392, 2.969815910683291, 2.9774743267030646, 2.9803609604335946, 3.0032183867079962, 3.0034540302778354, 3.0034540302778354]
gammaT6 = [2.9257206555750237, 3.0224238726605357, 3.1122295706957264, 3.1691539845371297, 3.2018725025957515, 3.2431077715590027, 3.2488928359408584, 3.2570996337296645, 3.260881897058419, 3.279864577161223, 3.284146384703209, 3.293352270918479, 3.297498018909857, 3.308170499653675, 3.308170499653675, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935]
JSRtrue = 2.9212307127312944

using Plots
using LaTeXStrings

gr(size = (600, 400))
fn = plot(1:1:Int64(2e1), 
Any[gammaT10,gammaT8,gammaT6,fill(JSRtrue,20)], 
label = ["T=10" "T=8" "T=6" "True JSR"],
line = [:solid :solid :solid :dashdot], 
xlabel=L"N(10^3)",ylabel=L"\gamma^*(\omega_N)",
legend=(0.8, 0.8),
lw = 2,xtickfontsize=12,ytickfontsize=12,legendfontsize=12)

savefig(fn,"fn.png")
=#

