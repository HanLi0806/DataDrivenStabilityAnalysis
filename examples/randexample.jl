using LinearAlgebra
using DynamicPolynomials
using SwitchOnSafety
using Combinatorics
using SparseArrays
using JuMP, MosekTools
using SpecialFunctions
using ControlSystems




include("../src/RandomTrajectories.jl")
include("../src/AlgebraicLift.jl")
include("../src/JSRCompute.jl")
include("../src/ProbabilisticCertificates.jl")




dim = 6; numMode = 3; dimOut = 3; horizon = 8;

numScen_budget = 20000

#A = [[-0.1 -0.50 -0.4; 1 0.2 0.1; 0 -0.9 0.8], [-0.1 0.9 -0.4; 0.5 0.9 -0.8; -0.8 0.5 0.5], [0.5 0.1 0.4; 0.8 0.8 0.2; -0.2 -0.9 -0.5]]
#C = [rand(dimOut,dim) for i in 1:numMode]

A = [4*rand(dim,dim).-2 for i in 1:numMode]
C = [2*rand(dimOut,dim).-1 for i in 1:numMode]
#A = [[0.33171530637435165 0.24755470028020454 -1.1013225492874126 0.42164974426079826 -0.8563040145169554 -0.36713329283395435; -0.9574086606854877 1.573099630442404 1.0210883718785526 0.5378286561296299 -0.2917768288322211 -1.0937933405312927; -1.110874390829001 0.3237899878249699 -0.49388112184525657 0.22990549207982536 1.9417520187012514 -1.308755622951467; 0.8268503417844917 -0.2183119290116462 0.6153654212337125 1.1612227781873266 1.2124276960007068 -1.533038945612394; -1.6223953980886874 -0.30581934776887376 -0.328294721385733 0.16875918492340158 0.8581498213196754 0.7513875560641372; -1.6641594469086618 -0.7687988000976294 1.6486186515795076 -0.17305389254272008 -0.38873415527804234 -0.14071343004230652], [-1.3265984047270276 0.25221500571520394 1.1910532378092293 -0.17264685023390047 0.746685671645289 0.9039353886712895; 1.0771718068882379 -0.9050881117434191 -0.20816019387390838 -1.5880490075672622 -0.06184312421968574 -0.10541268279057725; 0.6868210469610858 -0.17205708132667308 1.367595248589895 -0.07592260725407751 -1.3029184652423638 0.5998194632393119; 1.2897739963917703 -0.8015982436013349 0.041431623698807485 0.31768033569641396 1.7741790283937657 1.1085871421248195; -0.38584366064798914 -0.06152600315003287 1.36012690432897 -1.7910454150872193 1.342367304348909 -0.41482971471024577; -1.1233208210040688 0.7303490223624287 1.3363150828599553 0.6882169586455102 1.1657164568214613 -0.8664015676686914], [1.175267039285929 -0.30682181718291357 0.14515698002722832 0.31825521594731665 -0.40788821345022797 -0.68297988724684; -0.7242105592544421 1.7457564324897925 1.4408399448461093 -1.7523856956201076 -0.5769991550911744 -0.6376910483129006; 1.5453631398738894 -0.703000358761404 0.5242509314086856 1.6845418109667696 1.9466001268176463 -1.7059230785224635; -1.2358839195948184 1.3770180605448683 0.316694040630626 0.5164322017449141 -0.1566233817870053 1.6814379087986744; 1.2222077588202493 -1.004536193931437 -0.1900160343036843 1.4045384096383318 -0.22978993406983328 -1.4500470300625858; -0.21084191240944783 0.17318131553892346 0.7904466609949239 -0.980619159660054 0.5840731953868818 1.573767269262813]]
#C = [[-0.7026273723700056 -0.5509642000867689 -0.0011085510497546025 0.6910160253168023 0.7662367288302154 -0.5436944628366187; 0.14321669977656049 0.5243536800936051 0.6747151871640336 0.21518422235089885 -0.3401391338235067 0.08000874025660609; -0.13749126306669046 0.5774386327302481 -0.13782200002583433 0.9631367368604362 -0.7316762928712253 -0.703337035494354], [0.6784653141535966 -0.9309976392064634 0.8671251331376904 0.06264114219371963 -0.6660889916581874 -0.20730588712998754; 0.6322043309739858 -0.4108922725480446 0.25680168592111174 -0.9100964981330621 0.888728362603441 0.5420977984640767; 0.5753037875549603 0.47741091252747614 -0.6213308442251075 0.4402179420431809 0.8043039191127686 -0.7951142605870456], [-0.47835816739635284 0.6336181789709547 -0.9398273442128113 -0.0907376113826821 -0.2983042487547376 -0.817104214029531; -0.4733082091105385 0.6691514747720655 -0.7685741341944388 0.39764714842382887 -0.780299169372741 -0.0034902730279466887; -0.7708551991299015 -0.3231649215744361 -0.6055232904900141 -0.1898220906705812 0.016976214131142697 -0.2785438986147999]]
obsvtest = false
for i in 1:numMode
    global obsvtest
    if rank(obsv(A[i],C[i])) == dim
        obsvtest = true
    end
end
gammalist = []

println(obsvtest)
if obsvtest
#jsrwhite= white_box_jsr(A)
#println("JSR true: $jsrwhite")


traj_budget = generate_trajectories(horizon,A,C,numScen_budget)
hislen = 3
shift = horizon-hislen

state0_budget = traj_budget[1:hislen*dimOut,:]
state_budget = traj_budget[1+(horizon-hislen)*dimOut:end,:]


P0 = Matrix(1.0I, hislen*dimOut, hislen*dimOut)
Xscale = veroneseliftscale(hislen*dimOut,1)

for N in 1000:1000:numScen_budget

ga0 = convergerate(state0_budget[:,1:N],state_budget[:,1:N],1,P0,Xscale)
ga0 = ga0^(1/shift)
P,ga = data_driven_lyapb_sos(state0_budget[:,1:N],state_budget[:,1:N],shift,1,ga0,Xscale)
push!(gammalist,ga)

println(repeat('*', 80))
#println("JSR true: $jsrwhite")
println("gamma list: $gammalist")
println(repeat('*', 80))
end
end




#=
horizon = 10
JSR true: 2.9212307127312944
gamma list: Any[2.661683271549067, 2.7557365742142026, 2.7779657012946917, 2.7990002724806686, 2.8114132663410354, 2.8214371484123775, 2.836958482650755, 2.8511597949579177, 2.8593907596420687, 2.8596805823422144, 2.8621730575634716, 2.8685491569666874, 2.878403128771657, 2.878403128771657, 2.887735419716363, 2.889300462297153, 2.8895323204572696, 2.8895323204572696, 2.8905756821777957, 2.8915031148182635]

horizon = 8
gamma list: Any[2.7627663318452855, 2.8281605924645614, 2.8640201395226272, 2.8919736447096236, 2.911456390749046, 2.9164823745099397, 2.9378286875618285, 2.9782624445595838, 3.2393312414878332, 2.9844743346011384]
gamma list: Any[2.782307669564318, 2.802163083354567, 2.833193948622389, 2.8369914321341865, 2.904369639586344, 2.9109338610853066, 2.934970946767213, 2.943917130033138, 2.9585820760196855, 2.9602807184119504]
gamma list: Any[2.7771666443196965, 2.820040298359232, 2.861406113771846, 2.865772194424327, 2.8856434589324165, 2.8971494953319, 2.9167966238059675, 2.931584375152209, 2.9466147103971116, 2.9466147103971116, 2.947990235835291, 2.9488275121889664]

gamma list: Any[2.7437758739492653, 2.8214978364175725, 2.8319278272937685, 2.8705770320634305, 2.8882603668484546, 2.9042480873755365, 2.914498582663542, 2.9262218502630413, 2.9322307612939404, 2.9362956128736664, 2.9411852169478294, 2.943306009076382, 2.956914425234596, 2.963806999652392, 2.969815910683291, 2.9774743267030646, 2.9803609604335946, 3.0032183867079962, 3.0034540302778354, 3.0034540302778354]

horizon = 6
gamma list: Any[2.9257206555750237, 3.0224238726605357, 3.1122295706957264, 3.1691539845371297, 3.2018725025957515, 3.2431077715590027, 3.2488928359408584, 3.2570996337296645, 3.260881897058419, 3.279864577161223, 3.284146384703209, 3.293352270918479, 3.297498018909857, 3.308170499653675, 3.308170499653675, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935]


A = [[0.33171530637435165 0.24755470028020454 -1.1013225492874126 0.42164974426079826 -0.8563040145169554 -0.36713329283395435; -0.9574086606854877 1.573099630442404 1.0210883718785526 0.5378286561296299 -0.2917768288322211 -1.0937933405312927; -1.110874390829001 0.3237899878249699 -0.49388112184525657 0.22990549207982536 1.9417520187012514 -1.308755622951467; 0.8268503417844917 -0.2183119290116462 0.6153654212337125 1.1612227781873266 1.2124276960007068 -1.533038945612394; -1.6223953980886874 -0.30581934776887376 -0.328294721385733 0.16875918492340158 0.8581498213196754 0.7513875560641372; -1.6641594469086618 -0.7687988000976294 1.6486186515795076 -0.17305389254272008 -0.38873415527804234 -0.14071343004230652], [-1.3265984047270276 0.25221500571520394 1.1910532378092293 -0.17264685023390047 0.746685671645289 0.9039353886712895; 1.0771718068882379 -0.9050881117434191 -0.20816019387390838 -1.5880490075672622 -0.06184312421968574 -0.10541268279057725; 0.6868210469610858 -0.17205708132667308 1.367595248589895 -0.07592260725407751 -1.3029184652423638 0.5998194632393119; 1.2897739963917703 -0.8015982436013349 0.041431623698807485 0.31768033569641396 1.7741790283937657 1.1085871421248195; -0.38584366064798914 -0.06152600315003287 1.36012690432897 -1.7910454150872193 1.342367304348909 -0.41482971471024577; -1.1233208210040688 0.7303490223624287 1.3363150828599553 0.6882169586455102 1.1657164568214613 -0.8664015676686914], [1.175267039285929 -0.30682181718291357 0.14515698002722832 0.31825521594731665 -0.40788821345022797 -0.68297988724684; -0.7242105592544421 1.7457564324897925 1.4408399448461093 -1.7523856956201076 -0.5769991550911744 -0.6376910483129006; 1.5453631398738894 -0.703000358761404 0.5242509314086856 1.6845418109667696 1.9466001268176463 -1.7059230785224635; -1.2358839195948184 1.3770180605448683 0.316694040630626 0.5164322017449141 -0.1566233817870053 1.6814379087986744; 1.2222077588202493 -1.004536193931437 -0.1900160343036843 1.4045384096383318 -0.22978993406983328 -1.4500470300625858; -0.21084191240944783 0.17318131553892346 0.7904466609949239 -0.980619159660054 0.5840731953868818 1.573767269262813]]
C = [[-0.7026273723700056 -0.5509642000867689 -0.0011085510497546025 0.6910160253168023 0.7662367288302154 -0.5436944628366187; 0.14321669977656049 0.5243536800936051 0.6747151871640336 0.21518422235089885 -0.3401391338235067 0.08000874025660609; -0.13749126306669046 0.5774386327302481 -0.13782200002583433 0.9631367368604362 -0.7316762928712253 -0.703337035494354], [0.6784653141535966 -0.9309976392064634 0.8671251331376904 0.06264114219371963 -0.6660889916581874 -0.20730588712998754; 0.6322043309739858 -0.4108922725480446 0.25680168592111174 -0.9100964981330621 0.888728362603441 0.5420977984640767; 0.5753037875549603 0.47741091252747614 -0.6213308442251075 0.4402179420431809 0.8043039191127686 -0.7951142605870456], [-0.47835816739635284 0.6336181789709547 -0.9398273442128113 -0.0907376113826821 -0.2983042487547376 -0.817104214029531; -0.4733082091105385 0.6691514747720655 -0.7685741341944388 0.39764714842382887 -0.780299169372741 -0.0034902730279466887; -0.7708551991299015 -0.3231649215744361 -0.6055232904900141 -0.1898220906705812 0.016976214131142697 -0.2785438986147999]]
=#



#=
gammaT10 = [2.661683271549067, 2.7557365742142026, 2.7779657012946917, 2.7990002724806686, 2.8114132663410354, 2.8214371484123775, 2.836958482650755, 2.8511597949579177, 2.8593907596420687, 2.8596805823422144, 2.8621730575634716, 2.8685491569666874, 2.878403128771657, 2.878403128771657, 2.887735419716363, 2.889300462297153, 2.8895323204572696, 2.8895323204572696, 2.8905756821777957, 2.8915031148182635]
gammaT8 = [2.7437758739492653, 2.8214978364175725, 2.8319278272937685, 2.8705770320634305, 2.8882603668484546, 2.9042480873755365, 2.914498582663542, 2.9262218502630413, 2.9322307612939404, 2.9362956128736664, 2.9411852169478294, 2.943306009076382, 2.956914425234596, 2.963806999652392, 2.969815910683291, 2.9774743267030646, 2.9803609604335946, 3.0032183867079962, 3.0034540302778354, 3.0034540302778354]
gammaT6 = [2.9257206555750237, 3.0224238726605357, 3.1122295706957264, 3.1691539845371297, 3.2018725025957515, 3.2431077715590027, 3.2488928359408584, 3.2570996337296645, 3.260881897058419, 3.279864577161223, 3.284146384703209, 3.293352270918479, 3.297498018909857, 3.308170499653675, 3.308170499653675, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935, 3.3313066467206935]
JSRtrue = 2.9212307127312944

using Plots
using LaTeXStrings

gr(size = (600, 400))
fn = plot(1:1:Int64(2e1), 
Any[gammaT10,gammaT8,gammaT6,fill(JSRtrue,20)], 
label = ["T=10" "T=8" "T=6" "True JSR"],
line = [:solid :solid :solid :dashdot], 
xlabel=L"N(10^3)",ylabel=L"\gamma^*(\omega_N)",
legend=:bottomright,
lw = 2,xtickfontsize=12,ytickfontsize=12,legendfontsize=12)

savefig(fn,"fn.png")
=#